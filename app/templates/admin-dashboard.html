<!DOCTYPE html>
<html>
<head>
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<div class="container mt-5">

    <h2 class="mb-4">Admin Dashboard</h2>

    <div class="card">
        <div class="card-body">

            <table class="table table-bordered table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    <!-- Users will load here -->
                </tbody>
            </table>

        </div>
    </div>

</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

    const tableBody = document.getElementById("userTableBody");

    // =========================
    // Load Users
    // =========================
    fetchUsers();

    async function fetchUsers() {
        try {
            const response = await fetch("/api/admin/users", {
                method: "GET",
                credentials: "include"
            });
            
            if (response.status === 403){
                alert("Token expired login again")
                window.location.href = "/login"
            }
            const users = await response.json();
            renderUsers(users);

        } catch (error) {
            console.error("Error loading users:", error);
        }
    }

    function renderUsers(users) {
        tableBody.innerHTML = "";

        users.forEach(user => {
            tableBody.innerHTML += `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.first_name} ${user.last_name}</td>
                    <td>${user.email}</td>
                    <td>
                        <span class="badge bg-${user.role === 'admin' ? 'danger' : user.role === 'sub-admin' ? 'warning' : 'secondary'}">
                            ${user.role}
                        </span>
                    </td>
                    <td>
                        ${user.role !== 'sub-admin' ? `
                            <button class="btn btn-sm btn-warning promote-btn" data-id="${user.id}">
                                Promote
                            </button>
                        ` : ''}

                        <button class="btn btn-sm btn-danger delete-btn" data-id="${user.id}">
                            Delete
                        </button>
                    </td>
                </tr>
            `;
        });

        attachEventListeners();
    }

    // =========================
    // Promote User
    // =========================
    function attachEventListeners() {

        document.querySelectorAll(".promote-btn").forEach(button => {
            button.addEventListener("click", async () => {

                const userId = button.dataset.id;

                if (!confirm("Promote this user to sub-admin?")) return;

                const response = await fetch(`/api/admin/users/${userId}/promote`, {
                    method: "PUT",
                    credentials: "include"
                });
                if (response.status === 403){
                    alert("Token expired login again")
                    window.location.href = "/login"
                }
                if (response.ok) {
                    fetchUsers(); // refresh list
                } else {
                    alert("Error promoting user");
                }
            });
        });

        // =========================
        // Delete User
        // =========================
        document.querySelectorAll(".delete-btn").forEach(button => {
            button.addEventListener("click", async () => {

                const userId = button.dataset.id;

                if (!confirm("Are you sure you want to delete this user?")) return;

                const response = await fetch(`/api/admin/users/${userId}/delete`, {
                    method: "DELETE",
                    credentials: "include"
                });
                if (response.status === 403){
                    alert("Token expired login again")
                    window.location.href = "/login"
                }
                if (response.ok) {
                    fetchUsers(); // refresh list
                } else {
                    alert("Error deleting user");
                }
            });
        });
    }

});
</script>

</body>
</html>