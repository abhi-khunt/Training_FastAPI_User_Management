<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Login Form</title>

    <!-- Bootstrap 5 CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-5">

            <div class="card shadow">
                <div class="card-header text-center">
                    <h4>User Login</h4>
                </div>

                <div class="card-body">
                    <form class="needs-validation" novalidate>

                        <!-- Email -->
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email"
                                   class="form-control"
                                   name="email"
                                   required>
                            <div class="invalid-feedback">
                                Please enter a valid email.
                            </div>
                        </div>

                        <!-- Password -->
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password"
                                   class="form-control"
                                   name="password"
                                   required>
                            <div class="invalid-feedback">
                                Please enter your password.
                            </div>
                        </div>

                        <!-- Login Button -->
                        <div class="d-grid mb-3">
                            <button type="submit" class="btn btn-primary">
                                Login
                            </button>
                        </div>

                    </form>

                    <!-- Register Redirect Section -->
                    <div class="text-center">
                        <p class="mb-2">Don't have an account?</p>
                        <a href="/register" id="register button" class="btn btn-outline-secondary w-100">
                            Register
                        </a>
                    </div>

                </div>

            </div>

        </div>
    </div>
</div>

<!-- Bootstrap Validation Script -->
<script>
    const form = document.querySelector('.needs-validation')
   
    form.addEventListener('submit', async (event) => {
        event.preventDefault()
        if (!form.checkValidity()) {
            event.stopPropagation()
        }
        form.classList.add('was-validated')
        const formData = {
            email: form.email.value,
            password: form.password.value,
        };

        try {
            const response = await fetch("/api/users/login", {
                method: "POST",
                credentials: "include",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(formData)
            });

            const data = await response.json();

            if (response.ok) {
                alert("Login successful successful!");
                window.location.href = data.redirect;
            }
            else if(response.status === 404 || response.status === 403){
                alert("Invalid Credential")
                form.email.setCustomValidity("Invalid Email")
                form.password.setCustomValidity("Invalid Password")
            }
            else{

                alert( "Somethin went wrong");
            }

        } catch (error) {
            console.error(error);
            alert("Server error");
        }
    })
</script>

</body>
</html>